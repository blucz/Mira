"use strict";const e=require("electron"),_=require("node:os"),r=require("node:path"),S=require("path"),l=require("fs");process.env.DIST_ELECTRON=r.join(__dirname,"..");process.env.DIST=r.join(process.env.DIST_ELECTRON,"../dist");process.env.PUBLIC=process.env.VITE_DEV_SERVER_URL?r.join(process.env.DIST_ELECTRON,"../public"):process.env.DIST;_.release().startsWith("6.1")&&e.app.disableHardwareAcceleration();process.platform==="win32"&&e.app.setAppUserModelId(e.app.getName());e.app.requestSingleInstanceLock()||(e.app.quit(),process.exit(0));let n=null;const C=r.join(__dirname,"../preload/index.js"),R=process.env.VITE_DEV_SERVER_URL,v=r.join(process.env.DIST,"index.html");async function m(){n=new e.BrowserWindow({title:"Mira",icon:r.join(process.env.PUBLIC,"favicon.ico"),webPreferences:{preload:C,nodeIntegration:!0,contextIsolation:!1}}),process.env.VITE_DEV_SERVER_URL?(n.loadURL(R),n.webContents.openDevTools()):n.loadFile(v),n.webContents.on("did-finish-load",()=>{n==null||n.webContents.send("main-process-message",new Date().toLocaleString())}),n.webContents.setWindowOpenHandler(({url:o})=>(o.startsWith("https:")&&e.shell.openExternal(o),{action:"deny"}))}e.app.whenReady().then(async()=>{e.protocol.handle("atom",async s=>{const a=decodeURIComponent(s.url.slice(7));try{const c=(await l.promises.stat(a)).size,E=S.extname(a).toLowerCase(),g={".mp4":"video/mp4",".webm":"video/webm",".mov":"video/quicktime",".avi":"video/x-msvideo",".mkv":"video/x-matroska",".ogg":"video/ogg",".jpg":"image/jpeg",".jpeg":"image/jpeg",".png":"image/png",".gif":"image/gif",".webp":"image/webp",".bmp":"image/bmp"}[E]||"application/octet-stream",w=s.headers.get("Range");if(w){const i=w.replace(/bytes=/,"").split("-"),p=parseInt(i[0],10),f=i[1]?parseInt(i[1],10):c-1,d=f-p+1,h=Buffer.alloc(d),b=await l.promises.open(a,"r");return await b.read(h,0,d,p),await b.close(),new Response(h,{status:206,headers:{"Content-Type":g,"Content-Length":d.toString(),"Content-Range":`bytes ${p}-${f}/${c}`,"Accept-Ranges":"bytes"}})}else{const i=await l.promises.readFile(a);return new Response(i,{headers:{"Content-Type":g,"Content-Length":c.toString(),"Accept-Ranges":"bytes"}})}}catch(u){return console.error("Error loading file:",u),new Response("File not found",{status:404})}}),await m();const o=[{label:"File",submenu:[{label:"New",accelerator:process.platform==="darwin"?"Cmd+N":"Ctrl+N",click:m},{label:"Close",accelerator:process.platform==="darwin"?"Cmd+W":"Ctrl+W",role:"close"}]}],t=e.Menu.buildFromTemplate(o);e.Menu.setApplicationMenu(t),e.globalShortcut.register("CommandOrControl+F",()=>{n.setFullScreen(!n.isFullScreen())})});function I(o){e.shell.openPath(o).then(()=>{console.log("File opened successfully")}).catch(t=>{console.error("Error opening file:",t)})}e.app.on("window-all-closed",()=>{e.globalShortcut.unregister("CommandOrControl+F")});e.app.on("window-all-closed",()=>{e.globalShortcut.unregister("CommandOrControl+F"),n=null,process.platform!=="darwin"&&e.app.quit()});e.app.on("second-instance",()=>{n&&(n.isMinimized()&&n.restore(),n.focus())});e.app.on("activate",()=>{const o=e.BrowserWindow.getAllWindows();o.length?o[0].focus():m()});e.ipcMain.handle("open-file",(o,t)=>{const s=t.path;I(s)});e.ipcMain.handle("delete-image",(o,t)=>{const s=t.path;try{l.unlinkSync(s)}catch(a){console.error(a)}});e.ipcMain.handle("set-represented-file",(o,t)=>{n&&process.platform==="darwin"&&n.setRepresentedFilename(t.path)});e.ipcMain.handle("open-win",(o,t)=>{const s=new e.BrowserWindow({webPreferences:{preload:C,nodeIntegration:!0,contextIsolation:!1}});process.env.VITE_DEV_SERVER_URL?s.loadURL(`${R}#${t}`):s.loadFile(v,{hash:t})});
